--------------------------------------------
SSL Switcher - readme.txt
--------------------------------------------

[0.目次]
  1.概要
  2.動作確認環境
  3.インストール
  4.アンインストール
  5.使い方
  6.注意事項

[1.概要]
MODXのリソース毎にhttpとhttpsの設定を行い、自動でURLの変換をしたり、自動リダイ
レクトしてくれるプラグインです。
次のような機能があります。

  1)[~リソースID~]タグの拡張によるURL自動変換
    ファイルパスに展開する[~リソースID~]タグがhttps対応になります。
    https設定をしていないリソースのコンテンツ内にてhttps設定をしているリソース
    IDを[~リソースID~]タグに記述するとファイルパスが自動的にhttps://のURL付フ
    ルパスに展開されます。
    その逆の場合は同じようにhttp://のURL付フルパスに展開されます。

    *[~リソースID~]タグ展開早見表*

                          ↓[~リソースID~]タグに書かれるリソース
      |---------------------------------------------------------------|
      |                  | https設定なし       | https設定あり        |
      |---------------------------------------------------------------|
      |https設定なし     | 通常変換            | https+ドメイン付変換 |
      |https設定あり     | http+ドメイン付変換 | 通常変換             |
      |---------------------------------------------------------------|
       ↑タグを書くリソース


  2)httpからhttpsのページのリダイレクト
    https設定しているリソースに対してhttpでリクエストすると自動的にhttpsページ
    へとリダイレクトします。
    逆にhttps設定していないページにhttpsでリクエストするとhttpページへとリダイ
    レクトさせます。


[2.動作確認環境]
 ・MODX 1.0.5J-r11 (※1.0.5J-r11以降じゃないと動作しません)
 ・PHP5.3.8
 ・MySQL 5.5.18
 ・文字コード UTF-8


[3.インストール]
  1)アーカイブファイルを解凍します。

  2)管理画面でプラグインを新規作成します。
    ※「エレメント」→「エレメント管理」→「プラグイン」→「プラグインを作成」

    [メイン]
      プラグイン名    : SSLSwitcher
      プラグインコード: sslSwitcher.txtファイルの中身をそのまま張りつける

    [設定]
      以下の一行を「プラグイン設定」に貼り付け、「パラメータ表示を更新」を
      クリックする

&makeURLwithSSL=URL自動変換;list;true,false;true &rewriteBaseTag=baseタグ自動書き換え;list;true,false;true

      ※ここのプラグイン設定の詳細は下記[5.使い方]の2)を参照。

    [システムイベント]
      次のイベントにチェック

      ・OnWebPageInit
      ・OnWebPagePrerender
      ・OnMakeUrl

  3)管理画面でテンプレート変数を作成します。
    ※「エレメント」→「エレメント管理」→「テンプレート変数」
                                         →「テンプレート変数を作成」

    [メイン]
      変数名               : SSLSwitcher
      見出し               : SSLSwitcher
      入力タイプ           : Check Box
      入力時のオプション値 : HTTPS利用||自動リダイレクト禁止||URL書き換え禁止
      規定値               : (空白のまま)
      ウィジェット         : (選択無)

    [テンプレートとの関連付け]
      SSLSwitcherを有効にしたいテンプレートを選択
       (よくわかれなければ全てにチェックでもOKです)


[4.アンインストール]
作成したプラグインとテンプレート変数を削除します。


[5.使い方]
  1)管理画面でhttpsを使いたいリソースを編集します。
    テンプレート変数の部分に「HTTPS利用」「自動リダイレクト禁止」と書かれたチェ
    ックボックスが表示されているので、必要に応じてチェックをつけて保存します。
  
    ・HTTPS利用
      該当リソースはhttpsページとする

    ・自動リダイレクト禁止
      「HTTPS利用」にチェックしたリソースにhttpでアクセスしても自動でhttpsに
      リダイレクトしないようにする。
      同様にhttps→httsのリダイレクトも行われなくなる。

    ・URL書き換え禁止
      プラグイン設定で「URL自動変換」を有効にしていても、ここにチェックを入れた
      リソースは自動変換を行ないません。
      リンク元ページのhttp/https状態に合わせる形になります。


  2)プラグイン設定について

    ・URL自動変換
      trueを選択すると[~リソース~]タグの拡張が有効になる

    ・baseタグ自動書き換え
      trueを選択するとコンテンツ内の<base href="～">タグのhttp/https部分を
      設定に合わせて自動変換する

  ※[~リソースID~]タグ展開例
      サイトのURL
        -> http://ayd.jp/
      HTTPS利用未チェックのリソースID
        -> 10
      HTTPS利用チェックのリソースID
        -> 20

      例1.リソースID 10で以下の書き方をした場合の展開

         [~10~] → /index.php?q=10
         [~20~] → https://ayd.jp/index.php?q=20

      例2.リソースID 20で以下の書き方をした場合の展開

         [~10~] → http://ayd.jp/index.php?q=10
         [~20~] → /index.php?q=20


[6.注意事項]
  1)$modx->makeUrl()の動作も変わります
    makeUrl()内で処理をフックしているため、こちらでもSSL Switcherの設定に従っ
    てURLが生成されるためご注意ください。

  2)http->https(or https->http)へリダイレクトする際、QUERY_STRINGも合わせて
    リダイレクトします(POSTデータは削除されます)。

  3)https接続の判定は以下の環境変数を参考にしています

      ・HTTPS
      ・X-HTTPS
      ・HTTP_X_HTTPS

    利用しているサーバによってはうまく動作しない場合があり、もし違う環境変数
    でhttps接続判定ができる場合は以下のプラグイン設定を追加して、その環境変数
    を設定してください。

      &httpsKey=https判定環境変数Key;string;&httpsVal=https判定環境変数Val;string;

    判定環境変数Keyに環境変数名、判定環境変数Valにhttps接続時に入る値を入力し
    ます。
    追加するユーザが多い環境変数についてはSSL Switcher側で取り込んでもいいかな
    と思ってます。

  4)http/httpsでURLが違う場合
    現在調整中。
    プラグイン設定に次の設定を追加してhttp/httpsのドメインを入力させる。

      &url_http=HTTP側URL;string;&url_https=HTTPS側URL;string;

       例-1)HTTP側URL : www.example.com/
            HTTPS側URL: ssl.example.com/
       例-2)HTTP側URL : www.example.com/
            HTTPS側URL: ssl.example.com/ssl_dir/

